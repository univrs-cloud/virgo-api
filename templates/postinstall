#!/bin/bash

set -o pipefail

mkdir -p /var/www/virgo-api/app/cert/
openssl genrsa -out /var/www/virgo-api/app/cert/key.pem 4096
chmod 600 /var/www/virgo-api/app/cert/key.pem
openssl req -new -key /var/www/virgo-api/app/cert/key.pem -out /var/www/virgo-api/app/cert/csr.pem -subj "/CN=virgo/O=Organization/C=RO"
openssl x509 -req -days 365 -in /var/www/virgo-api/app/cert/csr.pem -signkey /var/www/virgo-api/app/cert/key.pem -out /var/www/virgo-api/app/cert/cert.pem -sha256
chmod 644 /var/www/virgo-api/app/cert/cert.pem

systemctl enable virgo-api.service

ischroot
if [ $? == 1 ]; then
	latest_lts=$(/usr/local/bin/n --lts 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
	installed_versions=$(/usr/local/bin/n ls 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
	if echo "$installed_versions" | grep -qx "$latest_lts"; then
		echo "Node.js LTS $latest_lts is already installed. Skipping install."
	else
		/usr/local/bin/n lts
		/usr/local/bin/n prune
		systemctl start virgo-api.service
	fi
fi

file_path="/etc/mail.rc"
line_to_add="set mta=/usr/bin/msmtp"
if ! grep -Fxq "$line_to_add" "$file_path"; then
	echo "$line_to_add" >> "$file_path"
fi
